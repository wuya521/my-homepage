<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>测试登录</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Worker 后端登录测试</h1>
    <button onclick="testAllEndpoints()">开始测试</button>
    <div id="results"></div>

    <script>
        const API_BASE = 'https://yahoohhblog.zalkbodenstein.workers.dev';

        async function testEndpoint(name, url, options = {}) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test';
            resultDiv.innerHTML = `<h3>${name}</h3><p>请求中...</p>`;
            document.getElementById('results').appendChild(resultDiv);

            try {
                const response = await fetch(url, options);
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    data = text;
                }

                resultDiv.className = 'test ' + (response.ok ? 'success' : 'error');
                resultDiv.innerHTML = `
                    <h3>${name}</h3>
                    <p><strong>状态:</strong> ${response.status} ${response.statusText}</p>
                    <p><strong>响应头:</strong></p>
                    <pre>${Array.from(response.headers.entries()).map(([k, v]) => `${k}: ${v}`).join('\n')}</pre>
                    <p><strong>响应体:</strong></p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.className = 'test error';
                resultDiv.innerHTML = `
                    <h3>${name}</h3>
                    <p><strong>错误:</strong> ${error.message}</p>
                `;
            }
        }

        async function testAllEndpoints() {
            document.getElementById('results').innerHTML = '';

            // 测试1: CORS 预检
            await testEndpoint(
                '测试1: OPTIONS 预检请求',
                `${API_BASE}/api/admin/login`,
                { method: 'OPTIONS' }
            );

            // 测试2: 无认证头的登录请求
            await testEndpoint(
                '测试2: 无认证头登录（应该失败）',
                `${API_BASE}/api/admin/login`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }
            );

            // 测试3: 正确的登录请求
            const authToken = 'Basic ' + btoa('admin:admin123');
            await testEndpoint(
                '测试3: 正确登录（admin/admin123）',
                `${API_BASE}/api/admin/login`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    }
                }
            );

            // 测试4: 错误密码
            const wrongToken = 'Basic ' + btoa('admin:wrongpassword');
            await testEndpoint(
                '测试4: 错误密码（应该返回401）',
                `${API_BASE}/api/admin/login`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': wrongToken
                    }
                }
            );

            // 测试5: 获取个人资料（公开接口）
            await testEndpoint(
                '测试5: 获取个人资料（公开）',
                `${API_BASE}/api/profile`,
                { method: 'GET' }
            );

            // 测试6: 访问需要认证的接口
            await testEndpoint(
                '测试6: 无认证访问管理接口（应该401）',
                `${API_BASE}/api/admin/vip-users`,
                { method: 'GET' }
            );

            // 测试7: 带认证访问管理接口
            await testEndpoint(
                '测试7: 带认证访问管理接口',
                `${API_BASE}/api/admin/vip-users`,
                {
                    method: 'GET',
                    headers: { 'Authorization': authToken }
                }
            );
        }
    </script>
</body>
</html>

