<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¡ èŠ±å›­äººç”Ÿ - æ–‡å­—å…»æˆæ¸¸æˆ</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .game-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .game-header { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md); }
        .game-title { font-size: 2rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .game-stats { display: flex; gap: var(--spacing-md); flex-wrap: wrap; }
        .stat-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: var(--spacing-sm) var(--spacing-md); display: flex; flex-direction: column; align-items: center; min-width: 100px; }
        .stat-label { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px; }
        .stat-value { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .game-nav { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); flex-wrap: wrap; }
        .game-nav-btn { flex: 1; min-width: 110px; padding: var(--spacing-md); background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .game-nav-btn:hover { background: var(--bg-card-hover); border-color: var(--primary-color); }
        .game-nav-btn.active { background: var(--primary-gradient); border-color: var(--primary-color); color: #FFFFFF; }
        .game-content { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--spacing-xl); min-height: 400px; }
        .farm-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-lg); }
        .farm-plot { background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-lg); text-align: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s ease; }
        .farm-plot:hover { border-color: var(--primary-color); }
        .plot-icon { font-size: 4rem; margin-bottom: var(--spacing-sm); }
        .plot-status { font-size: 0.875rem; color: var(--text-secondary); margin: var(--spacing-xs) 0; }
        .plot-timer { font-size: 1rem; font-weight: 600; color: var(--primary-color); }
        .plot-actions { display: flex; gap: var(--spacing-xs); margin-top: var(--spacing-sm); }
        .event-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-md); }
        .event-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm); }
        .event-description { font-size: 1rem; color: var(--text-secondary); line-height: 1.8; margin-bottom: var(--spacing-lg); }
        .event-options { display: flex; flex-direction: column; gap: var(--spacing-sm); }
        .event-option { padding: var(--spacing-md); background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); text-align: left; cursor: pointer; transition: all 0.3s ease; }
        .event-option:hover { background: var(--bg-card-hover); border-color: var(--primary-color); transform: translateX(5px); }
        .event-option-cost { font-size: 0.875rem; color: var(--error-color); margin-top: 4px; }
        .event-option-reward { font-size: 0.875rem; color: var(--success-color); margin-top: 4px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-lg); }
        .shop-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-md); text-align: center; transition: all 0.3s ease; }
        .shop-item:hover { border-color: var(--primary-color); transform: translateY(-3px); }
        .shop-item-icon { font-size: 3rem; margin-bottom: var(--spacing-sm); }
        .shop-item-name { font-size: 1.1rem; font-weight: 600; margin-bottom: var(--spacing-xs); }
        .shop-item-desc { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--spacing-sm); }
        .shop-item-price { font-size: 1.2rem; font-weight: 700; color: var(--primary-color); margin: var(--spacing-sm) 0; }
        .friend-list { display: flex; flex-direction: column; gap: var(--spacing-sm); margin-top: var(--spacing-lg); }
        .friend-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-md); display: flex; justify-content: space-between; align-items: center; }
        .ranking-list { display: flex; flex-direction: column; gap: var(--spacing-sm); margin-top: var(--spacing-lg); }
        .ranking-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-md); display: flex; justify-content: space-between; align-items: center; }
        .rank-number { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); min-width: 50px; }
        .rank-gold { color: #FFD700; }
        .rank-silver { color: #C0C0C0; }
        .rank-bronze { color: #CD7F32; }
        .loading { text-align: center; padding: var(--spacing-xl); color: var(--text-secondary); }
        .empty-state { text-align: center; padding: var(--spacing-xl); color: var(--text-muted); }
        .back-link { display: inline-block; margin-bottom: var(--spacing-lg); color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .back-link:hover { text-decoration: underline; }
        @media (max-width: 768px) {
            .game-nav-btn { min-width: 90px; font-size: 0.85rem; padding: var(--spacing-sm); }
            .farm-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
        <div class="game-header">
            <div class="game-title">ğŸ¡ èŠ±å›­äººç”Ÿ</div>
            <div class="game-stats">
                <div class="stat-item">
                    <div class="stat-label">âš¡ ä½“åŠ›</div>
                    <div class="stat-value" id="stat-energy">--/--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ğŸ’° é‡‘å¸</div>
                    <div class="stat-value" id="stat-coins">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">â­ ç­‰çº§</div>
                    <div class="stat-value" id="stat-level">Lv.--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ğŸ“… äº‹ä»¶</div>
                    <div class="stat-value" id="stat-events">--/--</div>
                </div>
                <div class="stat-item" id="blackdiamond-status" style="display: none; background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2)); border-color: #FFD700;">
                    <div class="stat-label">ğŸ’ é»‘é’»</div>
                    <div class="stat-value" id="stat-blackdiamond">--</div>
                </div>
            </div>
        </div>
        <div class="game-nav">
            <button class="game-nav-btn active" data-tab="checkin">ğŸ“… ç­¾åˆ°</button>
            <button class="game-nav-btn" data-tab="events">ğŸ“œ äº‹ä»¶</button>
            <button class="game-nav-btn" data-tab="farm">ğŸŒ» èŠ±å›­</button>
            <button class="game-nav-btn" data-tab="inventory">ğŸ’ èƒŒåŒ…</button>
            <button class="game-nav-btn" data-tab="friends">ğŸ‘¥ å¥½å‹</button>
            <button class="game-nav-btn" data-tab="shop">ğŸª å•†åº—</button>
            <button class="game-nav-btn" data-tab="rankings">ğŸ† æ’è¡Œ</button>
        </div>
        <div class="game-content">
            <div id="tab-checkin" class="tab-content">
                <h2>ğŸ“… æ¯æ—¥ç­¾åˆ°</h2>
                <p style="color: var(--text-secondary); margin: var(--spacing-md) 0;">æ¯å¤©ç­¾åˆ°å¯è·å¾—ä½“åŠ›ã€é‡‘å¸å’Œç»éªŒå¥–åŠ±ï¼</p>
                <button id="checkin-btn" class="btn-primary" style="margin-top: var(--spacing-lg);">ç«‹å³ç­¾åˆ°</button>
                <div id="checkin-message" class="message" style="display: none; margin-top: var(--spacing-md);"></div>
            </div>
            <div id="tab-events" class="tab-content" style="display: none;">
                <h2>ğŸ“œ ä»Šæ—¥å¥‡é‡</h2>
                <p style="color: var(--text-secondary); margin: var(--spacing-md) 0;">æ¯å¤©å¯ä»¥è§¦å‘éšæœºäº‹ä»¶ï¼Œåšå‡ºä¸åŒçš„é€‰æ‹©ä¼šè·å¾—ä¸åŒçš„å¥–åŠ±ï¼</p>
                <button id="next-event-btn" class="btn-primary" style="margin-top: var(--spacing-lg);">è§¦å‘äº‹ä»¶</button>
                <div id="event-container" style="margin-top: var(--spacing-lg);"></div>
            </div>
            <div id="tab-farm" class="tab-content" style="display: none;">
                <h2>ğŸŒ» æˆ‘çš„èŠ±å›­</h2>
                <p style="color: var(--text-secondary); margin: var(--spacing-md) 0;">ç§æ¤ä½œç‰©ï¼Œç­‰å¾…æˆç†Ÿåæ”¶è·å¥–åŠ±ï¼</p>
                <div style="margin: var(--spacing-md) 0;">
                    <button onclick="harvestAll()" class="btn-secondary" style="margin-right: 8px;">ğŸŒ¾ ä¸€é”®æ”¶è·</button>
                    <button onclick="loadFarm()" class="btn-secondary">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="farm-container" class="farm-grid"></div>
                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-primary); border-radius: var(--radius-sm);">
                    <h3 style="margin-bottom: var(--spacing-sm);">ğŸ“ è®¿å®¢è®°å½•</h3>
                    <div id="farm-visitors" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
                </div>
            </div>
            <div id="tab-inventory" class="tab-content" style="display: none;">
                <h2>ğŸ’ æˆ‘çš„èƒŒåŒ…</h2>
                <p style="color: var(--text-secondary); margin: var(--spacing-md) 0;">æŸ¥çœ‹å’Œä½¿ç”¨ä½ æ‹¥æœ‰çš„é“å…·ï¼</p>
                <div id="inventory-container" class="shop-grid"></div>
            </div>
            <div id="tab-friends" class="tab-content" style="display: none;">
                <h2>ğŸ‘¥ å¥½å‹äº’åŠ¨</h2>
                <p style="color: var(--text-secondary); margin: var(--spacing-md) 0;">è®¿é—®å¥½å‹çš„èŠ±å›­ï¼Œæµ‡æ°´ã€é€ç¤¼æˆ–å·èœï¼</p>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                    <input type="email" id="friend-email" class="input-field" placeholder="è¾“å…¥å¥½å‹é‚®ç®±" style="flex: 1;">
                    <button onclick="visitFriend()" class="btn-primary">è®¿é—®</button>
                </div>
                <div id="friends-container" style="margin-top: var(--spacing-lg);"></div>
                <div style="margin-top: var(--spacing-lg);">
                    <h3 style="margin-bottom: var(--spacing-sm);">æ¨èç©å®¶</h3>
                    <button onclick="loadPlayerList()" class="btn-secondary" style="margin-bottom: var(--spacing-sm);">åˆ·æ–°åˆ—è¡¨</button>
                    <div id="player-list" class="friend-list"></div>
                </div>
            </div>
            <div id="tab-shop" class="tab-content" style="display: none;">
                <h2>ğŸª ç¥ç§˜å•†åº—</h2>
                <p style="color: var(--text-secondary); margin: var(--spacing-md) 0;">ä½¿ç”¨é‡‘å¸è´­ä¹°ç§å­å’Œé“å…·ï¼</p>
                <div id="shop-container" class="shop-grid"></div>
            </div>
            <div id="tab-rankings" class="tab-content" style="display: none;">
                <h2>ğŸ† æ’è¡Œæ¦œ</h2>
                <div style="display: flex; gap: var(--spacing-sm); margin: var(--spacing-md) 0;">
                    <button onclick="loadRankings('wealth')" class="btn-secondary">ğŸ’° è´¢å¯Œæ¦œ</button>
                    <button onclick="loadRankings('harvest')" class="btn-secondary">ğŸŒ¾ æ”¶è·æ¦œ</button>
                    <button onclick="loadRankings('help')" class="btn-secondary">â¤ï¸ åŠ©äººæ¦œ</button>
                </div>
                <div id="rankings-container" class="ranking-list"></div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = window.API_BASE || 'https://yahoohhblog.zalkbodenstein.workers.dev';
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', ...options.headers }
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || data.error || 'è¯·æ±‚å¤±è´¥');
                return data;
            } catch (error) {
                console.error('APIé”™è¯¯:', error);
                throw error;
            }
        }
        let currentProfile = null, currentEvent = null, dailyEventLimit = 10, currentFarm = null;
        function getUserEmail() {
            return localStorage.getItem('userEmail') || prompt('è¯·è¾“å…¥æ‚¨çš„é‚®ç®±ä»¥å¼€å§‹æ¸¸æˆï¼š');
        }
        async function loadGameConfig() {
            try {
                const config = await apiRequest('/api/game/config');
                if (!config.enabled) { alert('æ¸¸æˆåŠŸèƒ½æš‚æœªå¼€æ”¾'); window.location.href = '/'; return; }
                dailyEventLimit = config.dailyEventLimit || 10;
            } catch (error) { console.error('åŠ è½½é…ç½®å¤±è´¥:', error); }
        }
        async function loadProfile() {
            const email = getUserEmail();
            if (!email) { alert('è¯·å…ˆè¾“å…¥é‚®ç®±'); window.location.href = '/'; return; }
            localStorage.setItem('userEmail', email);
            try {
                const result = await apiRequest(`/api/game/profile?email=${encodeURIComponent(email)}`);
                if (result.success) { currentProfile = result.profile; updateStats(); }
            } catch (error) { console.error('åŠ è½½æ¡£æ¡ˆå¤±è´¥:', error); alert('åŠ è½½å¤±è´¥: ' + error.message); }
        }
        function updateStats() {
            if (!currentProfile) return;
            document.getElementById('stat-energy').textContent = `${currentProfile.energy}/${currentProfile.maxEnergy}`;
            document.getElementById('stat-coins').textContent = currentProfile.coins;
            document.getElementById('stat-level').textContent = `Lv.${currentProfile.gameLevel}`;
            document.getElementById('stat-events').textContent = `${currentProfile.dailyEvents}/${dailyEventLimit}`;
            
            // æ˜¾ç¤ºé»‘é’»çŠ¶æ€
            if (currentProfile.blackDiamond && currentProfile.blackDiamond.active) {
                const bdStatus = document.getElementById('blackdiamond-status');
                const bdValue = document.getElementById('stat-blackdiamond');
                if (bdStatus && bdValue) {
                    bdStatus.style.display = 'flex';
                    const levelNames = ['', 'é»‘é’»1', 'é»‘é’»2', 'é»‘é’»3', 'é»‘é’»4'];
                    bdValue.textContent = levelNames[currentProfile.blackDiamond.level] || 'é»‘é’»1';
                }
            }
        }
        async function handleCheckin() {
            const email = getUserEmail();
            const btn = document.getElementById('checkin-btn');
            btn.disabled = true;
            btn.textContent = 'ç­¾åˆ°ä¸­...';
            try {
                const result = await apiRequest('/api/game/checkin', { method: 'POST', body: JSON.stringify({ email }) });
                if (result.success) {
                    currentProfile = result.profile;
                    updateStats();
                    const msg = document.getElementById('checkin-message');
                    msg.className = 'message success';
                    msg.style.display = 'block';
                    msg.textContent = `ç­¾åˆ°æˆåŠŸï¼è·å¾— ${result.rewards.energy} ä½“åŠ›ã€${result.rewards.coins} é‡‘å¸ã€${result.rewards.exp} ç»éªŒ`;
                    btn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                const msg = document.getElementById('checkin-message');
                msg.className = 'message error';
                msg.style.display = 'block';
                msg.textContent = error.message;
                btn.disabled = false;
                btn.textContent = 'ç«‹å³ç­¾åˆ°';
            }
        }
        async function handleNextEvent() {
            const email = getUserEmail();
            const btn = document.getElementById('next-event-btn');
            const container = document.getElementById('event-container');
            btn.disabled = true;
            btn.textContent = 'åŠ è½½ä¸­...';
            container.innerHTML = '<div class="loading">æ­£åœ¨å¯»æ‰¾å¥‡é‡...</div>';
            try {
                const result = await apiRequest('/api/game/event/next', { method: 'POST', body: JSON.stringify({ email }) });
                if (result.success && result.event && result.event.options) {
                    currentEvent = result.event;
                    const optionsHtml = result.event.options.map((option, index) => {
                        let costHtml = '', rewardHtml = '';
                        if (option.cost) {
                            const costs = [];
                            if (option.cost.energy) costs.push(`æ¶ˆè€— ${option.cost.energy} ä½“åŠ›`);
                            if (option.cost.coins) costs.push(`æ¶ˆè€— ${option.cost.coins} é‡‘å¸`);
                            if (costs.length > 0) costHtml = `<div class="event-option-cost">${costs.join('ã€')}</div>`;
                        }
                        if (option.reward) {
                            const rewards = [];
                            if (option.reward.coins) rewards.push(`+${option.reward.coins} é‡‘å¸`);
                            if (option.reward.exp) rewards.push(`+${option.reward.exp} ç»éªŒ`);
                            if (option.reward.items) {
                                Object.entries(option.reward.items).forEach(([itemId, count]) => {
                                    rewards.push(`+${count} ${itemId}`);
                                });
                            }
                            if (rewards.length > 0) rewardHtml = `<div class="event-option-reward">${rewards.join('ã€')}</div>`;
                        }
                        return `<button class="event-option" onclick="chooseOption(${index})">${option.text}${costHtml}${rewardHtml}</button>`;
                    }).join('');
                    container.innerHTML = `<div class="event-card"><div class="event-title">${result.event.title}</div><div class="event-description">${result.event.description}</div><div class="event-options">${optionsHtml}</div></div>`;
                    btn.textContent = 'è§¦å‘äº‹ä»¶';
                    btn.disabled = false;
                } else { throw new Error(result.message || 'äº‹ä»¶æ•°æ®æ— æ•ˆ'); }
            } catch (error) {
                showGameMessage(error.message, 'error');
                container.innerHTML = `<div class="empty-state">${error.message}</div>`;
                btn.textContent = 'è§¦å‘äº‹ä»¶';
                btn.disabled = false;
            }
        }
        async function chooseOption(optionIndex) {
            if (!currentEvent) return;
            const email = getUserEmail();
            const container = document.getElementById('event-container');
            container.innerHTML = '<div class="loading">å¤„ç†ä¸­...</div>';
            try {
                const result = await apiRequest('/api/game/event/choose', {
                    method: 'POST',
                    body: JSON.stringify({ email, eventId: currentEvent.id, optionIndex })
                });
                if (result.success) {
                    currentProfile = result.profile;
                    updateStats();
                    let message = 'é€‰æ‹©å®Œæˆï¼';
                    if (result.rewards.failed) {
                        message = 'å¾ˆé—æ†¾ï¼Œè¿™æ¬¡æ²¡æœ‰æˆåŠŸ...';
                        showGameMessage(message, 'error');
                    } else {
                        const rewards = [];
                        if (result.rewards.coins) rewards.push(`${result.rewards.coins} é‡‘å¸`);
                        if (result.rewards.exp) rewards.push(`${result.rewards.exp} ç»éªŒ`);
                        if (result.rewards.items) {
                            Object.entries(result.rewards.items).forEach(([itemId, count]) => {
                                rewards.push(`${count} ${itemId}`);
                            });
                        }
                        if (rewards.length > 0) {
                            message = `è·å¾—ï¼š${rewards.join('ã€')}`;
                            showGameMessage(message, 'success');
                        }
                    }
                    container.innerHTML = `<div class="event-card"><div class="event-title">âœ¨ ${message}</div><button class="btn-primary" onclick="handleNextEvent()" style="margin-top: var(--spacing-md);">ç»§ç»­å†’é™©</button></div>`;
                } else { throw new Error(result.message); }
            } catch (error) {
                showGameMessage(error.message, 'error');
                container.innerHTML = `<div class="empty-state">${error.message}</div>`;
            }
        }
        async function loadFarm() {
            const email = getUserEmail();
            const container = document.getElementById('farm-container');
            const visitorsContainer = document.getElementById('farm-visitors');
            container.innerHTML = '<div class="loading">åŠ è½½èŠ±å›­ä¸­...</div>';
            try {
                const result = await apiRequest(`/api/game/farm/status?email=${encodeURIComponent(email)}`);
                if (result.success) {
                    currentFarm = result.farm;
                    const plotsHtml = result.farm.plots.map(plot => {
                        let protectedBadge = plot.protected ? '<span style="color: var(--success-color);">ğŸ›¡ï¸ å—ä¿æŠ¤</span>' : '';
                        if (!plot.planted) {
                            return `<div class="farm-plot"><div class="plot-icon">ğŸŒ±</div><div class="plot-status">ç©ºåœ°</div><button class="btn-secondary" onclick="plantSeed(${plot.id})">ç§æ¤</button></div>`;
                        } else {
                            const now = new Date();
                            const harvestTime = new Date(plot.harvestAt);
                            const isReady = now >= harvestTime;
                            const icon = plot.seedType === 'seed_rare' ? 'ğŸŒº' : 'ğŸŒ±';
                            const wateredInfo = plot.watered > 0 ? `<div style="color: var(--success-color); font-size: 0.75rem;">ğŸ’§ è¢«æµ‡æ°´ ${plot.watered} æ¬¡</div>` : '';
                            const stolenInfo = plot.stolen > 0 ? `<div style="color: var(--error-color); font-size: 0.75rem;">ğŸ¥· è¢«å· ${plot.stolen} æ¬¡</div>` : '';
                            if (isReady) {
                                return `<div class="farm-plot"><div class="plot-icon">${icon}</div><div class="plot-status">å·²æˆç†Ÿï¼${protectedBadge}</div>${wateredInfo}${stolenInfo}<div class="plot-actions"><button class="btn-primary" onclick="harvestPlot(${plot.id})">æ”¶è·</button><button class="btn-secondary" onclick="useFertilizer(${plot.id})">è‚¥æ–™</button></div></div>`;
                            } else {
                                const remaining = Math.ceil((harvestTime - now) / 1000 / 60);
                                return `<div class="farm-plot"><div class="plot-icon">${icon}</div><div class="plot-status">ç”Ÿé•¿ä¸­ ${protectedBadge}</div><div class="plot-timer">è¿˜éœ€ ${remaining} åˆ†é’Ÿ</div>${wateredInfo}${stolenInfo}<div class="plot-actions"><button class="btn-secondary" onclick="useFertilizer(${plot.id})">è‚¥æ–™</button><button class="btn-secondary" onclick="useSpeedCard(${plot.id})">åŠ é€Ÿ</button></div></div>`;
                            }
                        }
                    }).join('');
                    container.innerHTML = plotsHtml;
                    
                    // æ˜¾ç¤ºè®¿å®¢è®°å½•
                    if (result.farm.visitors && result.farm.visitors.length > 0) {
                        const visitorsHtml = result.farm.visitors.slice(-5).reverse().map(v => {
                            const actionText = v.action === 'water' ? 'ğŸ’§ æµ‡æ°´äº†ä½ çš„èŠ±å›­' : v.action === 'steal' ? `ğŸ¥· å·èµ°äº† ${v.amount || 0} é‡‘å¸` : 'ğŸ é€äº†ä½ ç¤¼ç‰©';
                            const userName = v.email.split('@')[0];
                            return `<div>â€¢ ${userName} ${actionText}</div>`;
                        }).join('');
                        visitorsContainer.innerHTML = visitorsHtml;
                    } else {
                        visitorsContainer.innerHTML = '<div>æš‚æ— è®¿å®¢</div>';
                    }
                    
                    setTimeout(loadFarm, 60000);
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        async function harvestAll() {
            const email = getUserEmail();
            try {
                const result = await apiRequest('/api/game/farm/harvest-all', { method: 'POST', body: JSON.stringify({ email }) });
                if (result.success) {
                    showGameMessage(`ä¸€é”®æ”¶è·æˆåŠŸï¼æ”¶è· ${result.harvested} å—åœ°ï¼Œè·å¾— ${result.rewards.coins} é‡‘å¸ã€${result.rewards.exp} ç»éªŒ`, 'success');
                    currentProfile = result.profile;
                    updateStats();
                    await loadFarm();
                } else { throw new Error(result.message); }
            } catch (error) { showGameMessage('æ”¶è·å¤±è´¥: ' + error.message, 'error'); }
        }
        async function useFertilizer(plotId) {
            await useItem('fertilizer', plotId, 'è‚¥æ–™');
        }
        async function useSpeedCard(plotId) {
            await useItem('speed_card', plotId, 'åŠ é€Ÿå¡');
        }
        async function useItem(itemId, targetPlotId, itemName) {
            const email = getUserEmail();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é“å…·
            if (!currentProfile?.inventory?.[itemId] || currentProfile.inventory[itemId] <= 0) {
                showGameMessage(`æ²¡æœ‰${itemName}ï¼`, 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/api/game/item/use', {
                    method: 'POST',
                    body: JSON.stringify({ email, itemId, targetPlotId })
                });
                if (result.success) {
                    showGameMessage(result.message || `${itemName}ä½¿ç”¨æˆåŠŸï¼`, 'success');
                    await loadProfile();
                    await loadFarm();
                } else { throw new Error(result.message); }
            } catch (error) { showGameMessage(`ä½¿ç”¨å¤±è´¥: ${error.message}`, 'error'); }
        }
        async function plantSeed(plotId) {
            const commonCount = currentProfile?.inventory?.seed_common || 0;
            const rareCount = currentProfile?.inventory?.seed_rare || 0;
            
            if (commonCount === 0 && rareCount === 0) {
                showGameMessage('æ²¡æœ‰ç§å­ï¼è¯·å…ˆå»å•†åº—è´­ä¹°', 'error');
                return;
            }
            
            let options = 'è¯·é€‰æ‹©è¦ç§æ¤çš„ç§å­ï¼š\n';
            if (commonCount > 0) options += `1. æ™®é€šç§å­ (æ‹¥æœ‰${commonCount}ä¸ª)\n`;
            if (rareCount > 0) options += `2. ç¨€æœ‰ç§å­ (æ‹¥æœ‰${rareCount}ä¸ª)\n`;
            
            const choice = prompt(options, '1');
            if (!choice) return;
            
            let seedType = '';
            if (choice === '1' && commonCount > 0) {
                seedType = 'seed_common';
            } else if (choice === '2' && rareCount > 0) {
                seedType = 'seed_rare';
            } else {
                showGameMessage('æ— æ•ˆçš„é€‰æ‹©æˆ–ç§å­ä¸è¶³', 'error');
                return;
            }
            
            const email = getUserEmail();
            try {
                const result = await apiRequest('/api/game/farm/plant', { method: 'POST', body: JSON.stringify({ email, plotId, seedType }) });
                if (result.success) {
                    showGameMessage('ç§æ¤æˆåŠŸï¼ç­‰å¾…ä½œç‰©æˆç†Ÿå§', 'success');
                    await loadProfile();
                    await loadFarm();
                } else { throw new Error(result.message); }
            } catch (error) { showGameMessage('ç§æ¤å¤±è´¥: ' + error.message, 'error'); }
        }
        async function harvestPlot(plotId) {
            const email = getUserEmail();
            try {
                const result = await apiRequest('/api/game/farm/harvest', { method: 'POST', body: JSON.stringify({ email, plotId }) });
                if (result.success) {
                    showGameMessage(`æ”¶è·æˆåŠŸï¼è·å¾— ${result.rewards.coins} é‡‘å¸ã€${result.rewards.exp} ç»éªŒ`, 'success');
                    currentProfile = result.profile;
                    updateStats();
                    await loadFarm();
                } else { throw new Error(result.message); }
            } catch (error) { showGameMessage('æ”¶è·å¤±è´¥: ' + error.message, 'error'); }
        }
        async function loadShop() {
            const container = document.getElementById('shop-container');
            const items = [
                { id: 'seed_common', name: 'æ™®é€šç§å­', icon: 'ğŸŒ±', desc: '2å°æ—¶æˆç†Ÿï¼Œæ”¶è·100é‡‘å¸', price: 10 },
                { id: 'seed_rare', name: 'ç¨€æœ‰ç§å­', icon: 'ğŸŒº', desc: '4å°æ—¶æˆç†Ÿï¼Œæ”¶è·200é‡‘å¸', price: 50 },
                { id: 'fertilizer', name: 'è‚¥æ–™', icon: 'ğŸ’©', desc: 'åŠ é€Ÿä½œç‰©ç”Ÿé•¿50%', price: 30 },
                { id: 'speed_card', name: 'åŠ é€Ÿå¡', icon: 'âš¡', desc: 'ç«‹å³å®Œæˆç”Ÿé•¿', price: 100 },
                { id: 'protection_shield', name: 'é˜²å·ä¿æŠ¤ç½©', icon: 'ğŸ›¡ï¸', desc: 'ä¿æŠ¤èŠ±å›­24å°æ—¶', price: 200 }
            ];
            const html = items.map(item => {
                const owned = currentProfile?.inventory?.[item.id] || 0;
                return `
                <div class="shop-item">
                    <div class="shop-item-icon">${item.icon}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-desc">${item.desc}</div>
                    <div class="shop-item-price">ğŸ’° ${item.price}</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin: 4px 0;">æ‹¥æœ‰: ${owned}</div>
                    <button class="btn-primary" onclick="buyItem('${item.id}', ${item.price}, '${item.name}')">è´­ä¹°</button>
                </div>
            `}).join('');
            container.innerHTML = html;
        }
        async function buyItem(itemId, price, itemName) {
            if (!currentProfile || currentProfile.coins < price) {
                showGameMessage('é‡‘å¸ä¸è¶³ï¼', 'error');
                return;
            }
            if (!confirm(`ç¡®å®šè¦èŠ±è´¹ ${price} é‡‘å¸è´­ä¹° ${itemName} å—ï¼Ÿ`)) {
                return;
            }
            const email = getUserEmail();
            try {
                const result = await apiRequest('/api/game/shop/buy', {
                    method: 'POST',
                    body: JSON.stringify({ email, itemId, price })
                });
                if (result.success) {
                    currentProfile = result.profile;
                    updateStats();
                    showGameMessage(`è´­ä¹°æˆåŠŸï¼${itemName} å·²æ”¾å…¥èƒŒåŒ…`, 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showGameMessage('è´­ä¹°å¤±è´¥: ' + error.message, 'error');
            }
        }
        function showGameMessage(message, type = 'success') {
            const messageEl = document.createElement('div');
            messageEl.className = `game-toast ${type}`;
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
                font-weight: 600;
            `;
            document.body.appendChild(messageEl);
            setTimeout(() => messageEl.remove(), 3000);
        }
        async function loadPlayerList() {
            const container = document.getElementById('player-list');
            const email = getUserEmail();
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                const result = await apiRequest('/api/game/players?limit=10');
                if (result.success && result.players.length > 0) {
                    const html = result.players.filter(p => p.email !== email).slice(0, 8).map(player => {
                        const userName = player.email.split('@')[0];
                        return `
                            <div class="friend-item">
                                <div>
                                    <div style="font-weight: 600;">${userName}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Lv.${player.level} | ğŸ’°${player.coins} | ğŸŒ¾${player.totalHarvest}</div>
                                </div>
                                <button class="btn-secondary" onclick="quickVisit('${player.email}')">è®¿é—®</button>
                            </div>
                        `;
                    }).join('');
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state">æš‚æ— å…¶ä»–ç©å®¶</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥</div>`;
            }
        }
        function quickVisit(targetEmail) {
            document.getElementById('friend-email').value = targetEmail;
            visitFriend();
        }
        async function visitFriend() {
            const targetEmail = document.getElementById('friend-email').value.trim();
            if (!targetEmail) { showGameMessage('è¯·è¾“å…¥å¥½å‹é‚®ç®±', 'error'); return; }
            const email = getUserEmail();
            if (targetEmail === email) { showGameMessage('ä¸èƒ½è®¿é—®è‡ªå·±çš„èŠ±å›­', 'error'); return; }
            
            const container = document.getElementById('friends-container');
            const userName = targetEmail.split('@')[0];
            container.innerHTML = `
                <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-lg);">
                    <h3 style="margin-bottom: var(--spacing-md);">è®¿é—® ${userName} çš„èŠ±å›­</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md); font-size: 0.875rem;">
                        ğŸ’§ æµ‡æ°´ï¼šå¸®åŠ©å¥½å‹å¢åŠ æ”¶ç›Šï¼Œè·å¾—ç»éªŒ<br>
                        ğŸ¥· å·èœï¼šå·å–éƒ¨åˆ†é‡‘å¸ï¼ˆä¼šå‡å°‘å¥½å‹æ”¶ç›Šï¼‰<br>
                        ğŸ é€ç¤¼ï¼šæ¶ˆè€—20é‡‘å¸ï¼Œå¢åŠ å¥½æ„Ÿåº¦å’Œç»éªŒ
                    </p>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <button class="btn-primary" onclick="doFriendAction('${targetEmail}', 'water')" style="flex: 1;">ğŸ’§ æµ‡æ°´</button>
                        <button class="btn-secondary" onclick="doFriendAction('${targetEmail}', 'steal')" style="flex: 1;">ğŸ¥· å·èœ</button>
                        <button class="btn-secondary" onclick="doFriendAction('${targetEmail}', 'gift')" style="flex: 1;">ğŸ é€ç¤¼ (20é‡‘å¸)</button>
                    </div>
                </div>
            `;
        }
        async function doFriendAction(targetEmail, action) {
            const email = getUserEmail();
            try {
                const result = await apiRequest('/api/game/farm/visit', {
                    method: 'POST',
                    body: JSON.stringify({ email, targetEmail, action })
                });
                if (result.success) {
                    const messages = {
                        water: `æµ‡æ°´æˆåŠŸï¼è·å¾— ${result.rewards.exp} ç»éªŒ`,
                        steal: `å·èœæˆåŠŸï¼è·å¾— ${result.rewards.coins} é‡‘å¸`,
                        gift: `é€ç¤¼æˆåŠŸï¼è·å¾— ${result.rewards.exp} ç»éªŒ`
                    };
                    showGameMessage(messages[action] || 'æ“ä½œæˆåŠŸ', 'success');
                    await loadProfile();
                } else { throw new Error(result.message); }
            } catch (error) { showGameMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error'); }
        }
        async function loadRankings(type) {
            const container = document.getElementById('rankings-container');
            container.innerHTML = '<div class="loading">åŠ è½½æ’è¡Œæ¦œ...</div>';
            try {
                const result = await apiRequest(`/api/game/rankings?type=${type}&limit=20`);
                if (result.success && result.rankings.length > 0) {
                    const html = result.rankings.map((item, index) => {
                        let rankClass = '';
                        if (index === 0) rankClass = 'rank-gold';
                        else if (index === 1) rankClass = 'rank-silver';
                        else if (index === 2) rankClass = 'rank-bronze';
                        const userName = item.email.split('@')[0];
                        return `
                            <div class="ranking-item">
                                <div class="rank-number ${rankClass}">#${item.rank}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${userName}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Lv.${item.level}</div>
                                </div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-color);">${item.score}</div>
                            </div>
                        `;
                    }).join('');
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state">æš‚æ— æ’è¡Œæ•°æ®</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        async function loadInventory() {
            const email = getUserEmail();
            const container = document.getElementById('inventory-container');
            container.innerHTML = '<div class="loading">åŠ è½½èƒŒåŒ…ä¸­...</div>';
            try {
                const result = await apiRequest(`/api/game/inventory?email=${encodeURIComponent(email)}`);
                if (result.success && result.inventory.length > 0) {
                    const html = result.inventory.map(item => `
                        <div class="shop-item">
                            <div class="shop-item-icon">${item.icon}</div>
                            <div class="shop-item-name">${item.name}</div>
                            <div class="shop-item-desc">${item.description}</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-color); margin: var(--spacing-sm) 0;">æ•°é‡: ${item.count}</div>
                            ${item.type === 'consumable' ? `<button class="btn-primary" onclick="selectItemToUse('${item.id}', '${item.name}')">ä½¿ç”¨</button>` : ''}
                        </div>
                    `).join('');
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œå»å•†åº—è´­ä¹°é“å…·å§ï¼</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        function selectItemToUse(itemId, itemName) {
            if (itemId === 'fertilizer' || itemId === 'speed_card') {
                const plotId = prompt('è¯·è¾“å…¥è¦ä½¿ç”¨çš„æ ¼å­ç¼–å·ï¼ˆ0-3ï¼‰:', '0');
                if (plotId !== null) {
                    useItem(itemId, parseInt(plotId), itemName);
                }
            } else if (itemId === 'protection_shield') {
                useItem(itemId, null, itemName);
            } else {
                alert('è¯¥é“å…·æš‚æ—¶æ— æ³•ä½¿ç”¨');
            }
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.game-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            if (tabName === 'farm') loadFarm();
            else if (tabName === 'shop') loadShop();
            else if (tabName === 'inventory') loadInventory();
            else if (tabName === 'friends') loadPlayerList();
            else if (tabName === 'rankings') loadRankings('wealth');
        }
        document.addEventListener('DOMContentLoaded', async () => {
            await loadGameConfig();
            await loadProfile();
            document.getElementById('checkin-btn').addEventListener('click', handleCheckin);
            document.getElementById('next-event-btn').addEventListener('click', handleNextEvent);
            document.querySelectorAll('.game-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
        });
    </script>
</body>
</html>

